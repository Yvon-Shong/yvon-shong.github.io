---
title: ORB SLAM 2
date: 2021-12-28 12:00:00
categories: tech
tags: slam
toc: true
---

<!-- more -->


# 前端

## 提取  ORB 特征描述子
- 计算 8 层图像金字塔
- 将每层金字塔图像按网格划分
  - 对每个网格提取 FAST 角点
- 利用八叉树结构，将所有角点按区域分配
- 为每个角点保存尺度信息
- 利用灰度质心计算每个角点的角度
- 利用质心角度对角点 patch 的点进行旋转，计算 ORB 描述子

## 特征匹配
- 计算当前帧的 BoW 特征向量
- 设置匹配阈值
- 只在属于同一个 BoW 词汇的特征点之间进行匹配
  - 查找当前帧和匹配帧 BoW 特征向量 ID 一样的词汇
  - 每个词汇 ID（可能）包含同一个图像多个特征点
  - 对两帧间对应节点的所有特征点进行逐一匹配
  - 利用最近邻比例法筛选最佳匹配特征
  - 统计匹配对之间特征点到主方向
- 保存特匹配对之间特征点主方向最多的前三名，将其他角度的匹配点全部剔除
- 利用 PNP 优化匹配对，剔除不满足图优化的点

## 运动估计
1. 无运动模型的跟踪
   - 当前帧与前一关键帧的相对运动关系未知
   - 利用上述特征匹配对方法找到当前帧与前一关键帧的最优匹配对
   - 根据 PNP 方法计算当前帧的位姿
2. 带有运动模型的跟踪
   - 当前帧与前一帧的相对关系确定（匀速运动里程计）
   - 利用预测的位姿，将三维点投影到当前帧的像素平面中
   - 在预设的阈值半径里查找投影点附近存在的特征点作为候选点
   - 筛除已经匹配过的候选点
   - 筛除右视图超过预设半径的候选点
   - 计算匹配分数，分数最高的候选点为最优匹配
   - 统计特征点的主方向，保留三位匹配对最多的主方向
   - 利用上述匹配对进行位姿图优化，计算当前帧的位姿
3. 跟踪丢失时，进行重定位（具体在回环检测分析）

## 局部优化

有足够匹配点，跟踪局部地图
- 更新局部关键帧
  - 将当前帧的所有共视关键帧加入局部关键帧中
  - 将所有共视关键帧相关的关键帧也加入局部关键帧中
- 更新局部地图点
  - 将上述所有关键帧中非当前帧的地图点全部加入局部地图中
- 在局部地图中为当前帧找到更多匹配对
- 利用姿态图优化对当前帧位姿进行优化
  - 初始化优化器并设置求解算法
  - 设置顶点（当前帧）
  - 设置观测边（当前帧观测到的地图点）
  - 进行四次优化，逐渐剔除外点
  - 恢复当前帧的位姿
- 更新地图点的统计数据
  - 若刚刚重定位过，则要求内点数不少于 50
  - 若正常情况下，内点数不少于 30


## 关键帧检测

- 若处于纯定位模式，不插入关键帧
- 若局部地图处于全局闭环情况下，不插入关键帧
- 若距离上次重定位较近，不插入关键帧
- 插入关键帧的条件
  - 距离上次插入关键帧过于许多帧（max）
  - 距离上次插入关键帧过去许多帧（min）且局部地图处于空闲状态
  - 内点数大于阈值且重叠度不能太大
  - 局部地图中的关键帧队列不能超过 3 个

## 插入关键帧

- 中断当前局部见图
- 更新当前帧位姿信息
- 将当前帧所有点按深度进行排序
- 若地图点未创建/未观测，插入关键帧
  - 为关键帧所有点创建局部地图（即使是匹配过程中被剔除的点）
    - 利用相机内参将像素点反投影回三维空间并创建地图点
    - 为地图点关联当前帧与特征点索引（观测）
    - 从当前地图点所有观测中计算得到最有分辨力对描述子
    - 从当前地图点所有观测中计算得到平均法向量
    - 从当前帧与参考帧的光心计算距离范围
    - 将地图点插入地图
  - 将关键帧插入局部地图

# 局部建图

## 关闭插入关键帧


## 检查局部地图队列中是否有关键帧（来自跟踪阶段插入到关键帧）

## 将关键帧插入地图

- 从候选关键帧中取出第一个关键帧并从队列中将其删除
- 计算当前关键帧的 BoW 结构
- 读取当前关键帧所有地图点
- 若地图点不在当前关键帧的观测中
  - 关联当前帧和地图点 ID（观测）
  - 更新地图点的法向量和深度信息
  - 计算更有特异性的描述子
- 若地图点在当前关键帧的观测中
  - 添加到最近的地图点集合中
- 更新共视图
  - 读取当前关键帧所有的地图点
  - 提取每个地图点的所有观测
  - 统计当前帧与其他关键帧的共同观测点数量
    - 共同观测点数大于 15 的关键帧与当前关键帧建立一条共视边
    - 若无满足阈值条件的关键帧，则与共同观测数量最多的关键帧建立共视边
    - 将当前关键帧与不同关键帧的共同观测数量进行排序
    - 选取共同观测最小的关键帧作为父节点，并将当前关键帧添加到子节点中

## 剔除地图点

- 当前地图点被所有关键帧观测到的比例低于 0.25
- 当前地图点被观测次数过少且超过连续两帧未观测到
- 当前点在连续三帧内未被观测到


## 三角化新的地图点

## 在邻域关键帧中查找更多匹配对

- 在共视关键帧中读取所有相邻关键帧
  - 在相邻关键帧个字的共视关键帧中再取出前 5 个关键帧
- 将当前关键帧的所有地图点于相邻帧进行融合
  - 将每个地图点投影到相邻关键帧中
  - 在投影点邻域内查找候选特征
  - 在所有候选帧中找到最优匹配
  - 若该观测点已经存在则替换
  - 若该观测点不存在则创建新的观测
- 将所有相邻关键帧的地图点与当前关键帧进行融合
  - 步骤与上述相同，但投影对象相反
- 为每个地图点计算分辨力强的描述子
- 为每个地图点计算法向量和深度信息
- 更新共视图

## 执行局部 BA
- 将当前帧共视图中的所有关键帧加入局部关键帧中进行优化
- 将上述局部关键帧所有地图点全部加入局部地图点中作为边
- 将观测到上述局部地图点却没有包含在局部关键帧的关键帧添加到固定关键帧中
- 初始化优化器并设置优化算法
- 对局部关键帧位姿进行 4 次相同的优化
- 剔除所有不满足误差条件的地图点
- 恢复优化后到地图点和关键帧位姿

## 检查并剔除冗余的局部关键帧

- 对当前关键帧局部共视图中所有关键帧进行检验
  - 地图点在其他至少 3 帧中重复率高达 90% 对关键帧筛除

## 向回环模块插入当前关键帧

- 插入关键帧的同时终止 BA

## 重启插入关键帧




# 回环检测

## 检查队列中是否有关键帧

## 若只有不到 10 个关键帧/距上一次回环不到 10 个关键帧则不需要回环检测

## 外观验证

- 从共视图所有关键帧中与当前关键帧计算 BoW 最低到匹配分数 min_s 作为参考值
- 从数据库中检测满足最低匹配分数的候选帧
  - 在数据库中查找与当前关键帧有重合词汇的关键帧，并统计重合词汇数量
  - 排除当前关键帧的共视图关键帧
  - 去最相似关键帧重叠词汇数目对 80% 作为最低标准筛选候选帧
  - 取匹配分数高于最低匹配分数 min_s 的关键帧作为候选帧集
  - 累计每个候选帧共视图关键帧的匹配分数（即各个候选帧共视图的交集）
  - 取 0.75 * 最大累计匹配分数确定最后的候选帧集
- 获取每个候选帧的共视图关键帧
- 每个候选帧的共视图关键帧与上一次回环检测 group 对关键帧有重复即满足一致性
- 一旦 group 对一致性满足阈值条件，则说明检测到回环（即同一个回环被检测到多次）
- 更新一致性 group，即将当前 group 替换过去的 group
- 将当前关键帧添加到数据库中
- 对所有满足一致性条件的候选帧进行几何验证


## 几何验证

- 遍历满足一致性条件的候选帧
- 计算当前关键帧与候选帧的特征匹配关系
  - 在候选帧中为当前关键帧的每个描述子找到匹配的点
- 满足匹配对阈值条件的设为候选帧并设置求解器，否则剔除
- 对求解器进行 5 次迭代求解相对运动
- 根据相对运动关系进行冲投影匹配以找到更好的匹配对
  - 标注已经匹配成功的描述子
  - 从当前帧投影到候选帧
    - 将当前帧的地图点根据相对运动关系投影到候选帧图像平面中
    - 根据地图点的模长预测尺度信息并由此得到匹配半径
    - 在投影点匹配半径内查找最有匹配记录并记录对应 ID
  -  从候选帧投影到当前帧，反向投影
     - 将候选帧的地图点根据相对运动投影到当前帧图像平面中
     - 同样的方法获得匹配半径以及查找最优匹配
     - 对比两次重投影匹配，对应的匹配点是否一致
- 进一步用优化器来优化匹配对
- 匹配内点数量超过阈值条件则进行下一步验证
- 利用重投影计算当前帧与候选帧及其共视帧的匹配关系
  - 根据候选帧的匹配关系，估计当前帧相对于世界坐标对运动 $T_{c}^{w}$
  - 从 $T_{c}^{w}$ 恢复当前帧的相机位置和姿态
  - 将候选帧及其共视图关键帧的所有地图点投影到当前帧中（建立回环帧和当前帧的关系）
  - 根据地图点对尺度信息确定查询半径
  - 为当前帧每个灭数字找到一个最优匹配
- 匹配数量满足阈值条件则说明候选帧是回环帧


# 闭环

回路

- 检测到回环，终止全局 BA
- 更新当前帧的共视图关键帧
- 利用回环帧估算的当前帧姿态，更新共视图的所有关键帧的姿态
- 根据新的姿态信息矫正当前帧及其共视图关键帧的所有地图点
  - 利用旧姿态将空间点投影到图像平面，利用新姿态反投影回三维空间
  - 更新共视图关键帧
- 利用与回环帧匹配的地图点替换当前关键帧对应的地图点
- 融合地图重复点
  - 遍历所有矫正位姿的共视图关键帧
  - 利用每个共识图关键帧的姿态将回环帧及其邻域对所有地图点投影到各自图像平面
  - 同几何验证阶段的重投影匹配一样计算新的匹配对
  - 将上述当前帧及其共视图关键帧的匹配地图点用回环帧及其邻域的地图点替换
- 更新当前帧共视图关键帧，确保当前帧与回环帧建立联系
- 优化 Essential Graph
  - 设置优化求解器和优化算法
  - 设置所有的顶点（设置更新后的位姿）
  - 设置当前帧/回环帧与相邻帧构成的边（设置相对运动变换）
  - 若关键帧有回环帧，则添加一条边（设置相对运动）
  - 每个关键帧共视图中共视点大于阈值则添加一条边（设置相对运动）
  - 初始化算法并迭代 20 次进行优化
  - 利用优化后对姿态重置所有关键帧位姿
  - 将地图点通过旧位姿投影到对应关键帧，再根据优化后的姿态反投影回空间
- 启动新的线程执行全局 BA
  - 启动全局 BA
    - 添加所有关键帧为顶点
    - 添加所有地图点为顶点
    - 添加每个关键帧地图点与所有有关联的关键帧之间的边
    - 执行全局优化
    - 更新关键帧位姿和地图点位置
  - 更新所有关键帧的位姿
  - 利用优化后的位姿更新所有地图点










![](https://img2018.cnblogs.com/blog/948709/201909/948709-20190928121021086-928444511.jpg)

> [小 C 酱油兵:（十二）ORBSLAM2系统流程所有细节](https://www.cnblogs.com/yepeichu/p/11602502.html)



